/*! sequence-viewer 2015-07-22 */
function Sequence(a,b){function c(b,c){if(q=b,"undefined"==typeof c)var c={showLineNumbers:!0,wrapAminoAcids:!0,charsPerLine:50,search:!1,toolbar:!1};else r=c;t="undefined"==typeof c.charsPerLine?50:c.charsPerLine;var d='<div id="sequenceHeader" class="row" style="border-bottom: 1px solid #E7EAEC;padding-bottom:5px;margin:0px 0px 15px"><div style="display:inline-block;"><span class="badge" style="border-radius:70%;border: 2px solid black;color:#C50063;padding:8px 5px;background-color:white;margin-right:10px;vertical-align:middle;">{{sequenceLength}}</span></div><h4 style="display:inline-block;vertical-align:middle;">Protein Sequence</h4></div><div id="sequenceBody" style="margin-top: 5px;"><div id="scroller" style="max-height:400px;overflow:auto;white-space: nowrap;padding-right:20px;margin-right:10px;s"><div id="charNumbers" style="font-family: monospace;font-size: 13px;display:inline-block;text-align:right; padding-right:5px; border-right:1px solid LightGray;"></div><div id="fastaSeq" display-option="'+t+'" style="font-family: monospace;font-size: 13px;display:inline-block;padding:5px;">{{{sequence}}}</div></div><div id="coverageLegend" style="margin-top: 10px;margin-left:15px;"></div></div>',e=Handlebars.compile(d),f=e({sequence:a,sequenceLength:a.length});$(b).html(f),c.wrapAminoAcids!==!1?k(b+" #fastaSeq"):$(b+" #scroller").css("overflow-x","auto"),c.showLineNumbers!==!1&&j(b+" #fastaSeq",b+" #charNumbers"),c.search&&l(),c.toolbar&&(o(),""!==p&&$(q+" #sequenceToolbar").append('<a class="btn btn-default" href="http://www.nextprot.org/db/entry/'+p.split("-")[0]+"/fasta?isoform="+p.slice(3)+'" style="margin-left:15px;">view Fasta</a><a class="btn btn-default disabled" href="" style="margin-left:15px;">Blast sequence</a><a class="btn btn-default disabled" href="" style="margin-left:15px;">Blast selection</a>')),s=$(b+" #fastaSeq").html()}function d(a,b,c){var d=[a,b],e=s;d[0]=d[0]+~~(d[0]/10)+4*~~(d[0]/t),d[1]=d[1]+~~(d[1]/10)+4*~~(d[1]/t);e=e.substring(0,d[0])+"<span id='stringSelected' style=\"background:"+c+';color:white;">'+e.substring(d[0],d[1])+"</span>"+e.substring(d[1],e.length),$(q+" #fastaSeq").html(e)}function e(a,b){(new Date).getTime();0===a.length&&$(q+" #fastaSeq").html(s);var c=s,d=c.toString();console.log("length : "+a.length);var e=0,f=0;for(i in a)e=g(a[i].start),f=g(a[i].end),d=d.substring(0,e)+"<span class='stringsSelected' style=\"background:"+b+';color:white;">'+d.substring(e,f)+"</span>"+d.substring(f,d.length);$(q+" #fastaSeq").html(d)}function f(a){for(var b=0;b<a.length;b++)a[b].underscore===!0?($(q+" #coverageLegend").append('<div style="display:inline-block;background:'+a[b].color+';width:20px;height:20px;vertical-align:middle;margin:0px 5px 0px 10px;border-radius:50%; border: 1px solid grey;text-align:center; line-height:0.8;">_</div><p style="display:inline-block;font-weight:bold;font-size:11px;font-style:italic;margin:0;padding-top:3px;vertical-align:top;">'+a[b].name+"</p></div>"),console.log("duh !")):($(q+" #coverageLegend").append('<div style="display:inline-block;background:'+a[b].color+';width:20px;height:20px;vertical-align:middle;margin:0px 5px 0px 10px;border-radius:50%;"></div><p style="display:inline-block;font-weight:bold;font-size:11px;font-style:italic;margin:0;padding-top:3px;vertical-align:top;">'+a[b].name+"</p>"),console.log("dah !"))}function g(a){var b=a+~~(a/10)+4*~~(a/t);return b}function h(a,b,c,d){a.sort(function(a,b){return a.start-b.start});var e=(new Date).getTime();if(!b)var b=0;if(!c)var c=0;if(!d)var d="#FFE5A3";for(var f="",h="",i=0;i<a.length;i++)a[i].underscore?(h='<span style="text-decoration:underline;color:'+a[i].color+';">',f+=h):(h='<span style="color:'+a[i].color+';">',f+=h),c?b>=a[i].start&&b<a[i].end&&c>=a[i].start&&c<a[i].end?(f+=s.substring(g(a[i].start),g(b))+'<span id="peptideHighlighted" style="background:'+d+';">'+s.substring(g(b),g(c+1)),f+="</span>"+s.substring(g(c+1),g(a[i].end))+"</span>"):f+=b>=a[i].start&&b<a[i].end?s.substring(g(a[i].start),g(b))+'</span><span id="peptideHighlighted" style="background:'+d+';">'+h+s.substring(g(b),g(a[i].end))+"</span>":c>=a[i].start&&c<a[i].end?s.substring(g(a[i].start),g(c+1))+"</span></span>"+h+s.substring(g(c+1),g(a[i].end))+"</span>":s.substring(g(a[i].start),g(a[i].end))+"</span>":f+=s.substring(g(a[i].start),g(a[i].end))+"</span>";$(q+" #fastaSeq").html(f);var j=(new Date).getTime();console.log("Time to execute all: ",j-e)}function j(a,b){for(var c=$(a).html().split("<br>"),d=parseInt($(a).attr("display-option")),e=[],f=0,g=0;g<c.length;g++)e.push(f+1+"<br>"),f+=d;$(b).html(e.join(""))}function k(a){var b=parseInt($(a).attr("display-option"));b=(b+b/10).toString();var c=$(a).html();c=c.toString().match(/.{1,10}/g).join(" ").match(new RegExp(".{1,"+b+"}","g")).join("<br>"),$(a).html(c)}function l(){$(q+" #sequenceHeader").append('<input id="inputSearchSeq" type="text" class="form-control pull-right" style="width:40%;margin-top:3px;" placeholder="Search in sequence.. (Regex supported)">'),m()}function m(){$(q+" #inputSearchSeq").keyup(function(){var b=$(this).val();if(""!==b){var c,d=new RegExp(b,"gi"),f=[];for(console.log("while begin");null!=(c=d.exec(a));)f.push({start:c.index,end:c.index+c[0].length});console.log("while finished"),f.sort(function(a,b){return b.start-a.start}),console.log("matches sorted"),e(f,"#C50063"),console.log("matches highlighted")}else $(q+" #fastaSeq").html(s)})}function n(a){console.log("BANANAAAAAAAA!!");var b=r;b.charsPerLine=a.value,c(q,b)}function o(){var a=["50","60","70","80","90","100"],b='<form class="form-inline" role="form"><div id="sequenceToolbar" class="row"style="margin-bottom:15px;"><div class="input-group" style="margin-left:20px;"> <span class="input-group-addon">Char per line</i></span><select id="CPLChoice" class="form-control" style="border-top-left-radius: 0px;border-bottom-left-radius: 0px;"><option>Select</option>{{#each CPL}}<option value={{this}}>{{this}}</option>{{/each}}</select></div></div></form>',c=Handlebars.compile(b),d=c({CPL:a});$(q+" #sequenceBody").prepend(d),$(q+" #CPLChoice").change(function(){n(this),$(q+" #CPLChoice option:selected").text($(this).val())})}var p;p=void 0!==b?b:"",console.log(p);var q,r,a=a,s="",t=0;return{render:c,selection:d,coverage:h,addLegend:f}}